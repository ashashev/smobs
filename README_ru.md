[English](README.md)

# smobs ![build status][build-status]

Утилита для миграции репозиториев с одного Bitbucket Server на другой.

## Использование

Рекомендуется отключить запрос пароля git и выключить антивирус. Для работы с репозиториями используется протокол http(s). Самый простой способ отключить запрос пароля в git это настроить [credential store][git-credential-store].

Для запуска утилиты используется Java 8. Команда запуска может выглядеть следующим образом:

```
java -jar smobs-assembly-0.0.2.jar [options]
```

Справку по доступным опциям можно получить выполнив команду:

```
java -jar smobs-assembly-0.0.2.jar --help
```

Опций:

* `-c, --config <value>`  путь к конфигурационному файлу, по-умолчанию ищет в каталоге запуска файл smobs.json
* `-e, --example` вывести в стандартный поток вывода пример конфигурационного файла
* `-n, --no-migrate` не выполнять миграцию, выведет в стандартный поток вывода предполагаемые операции с проектами и репозиториями. Рекомендуется с этой опцией перенаправить поток ошибок `java -jar smobs-assembly-0.0.2.jar -n 2> errors.log`.

Файл конфигурации это JSON файл в котором описываются параметры доступа к серверам и фильтры проектов.

Пример конфигурационного файла:

```json
{
  "source":{
    "url":"http://example.com",
    "user":"<your login>",
    "password":"<your password>",
    "connectionTimeoutMs":1000,
    "readTimeoutMs":5000
  },
  "destination":{
    "url":"http://example.com",
    "user":"<your login>",
    "password":"<your password>",
    "connectionTimeoutMs":1000,
    "readTimeoutMs":5000
  },
  "useCredential":false,
  "includeProjects":[
    ".*"
  ],
  "excludeProjects":[
    
  ],
  "includeUsers":[
    ".*"
  ],
  "excludeUsers":[
    
  ],
  "addedProjectPrefix":""
}

```

* `source` - параметры доступа к Bitbucket Server который будет выступать в качестве источника.
* `destination` - параметры доступа к Bitbucket Server на который будут мигрировать проекты.
* `includeProjects` - список регулярных выражений для отбора проектов для миграции.
* `excludeProjects` - список регулярных выражений для отбора проектов, которые нужно исключить из миграции. Имеют более высокий приоритет.
* `useCredential` - создавать и использовать файл для [git credential store][git-credential-store]
* `includeUsers`, `excludeUsers` - аналогично `includeProjects`, `excludeProjects`, но для миграции персональных проектов.
* `addedProjectPrefix` - префикс, который будет добавлен к имени проекта на сервере назначения. Так же добавляется для ключа проекта в случаи конфликта.

Утилита воссоздает структуру проектов на целевом сервере. Если задан `addedProjectPrefix`, то он вставляется перед именем проекта с исходного сервера. Если такой проект уже существует, то он будет использовать как целевой. При необходимости создания нового проекта, ключ проекта берется с исходного сервера. Но если такой ключ уже существует на принимающем сервере, то к нему подставляется `addedProjectPrefix`, если и такой ключ есть, то к исходному ключу дописывется индекс `2`, потом `3` и т.д. В случае когда ключ проекта уже заканчивается индексом, например `TMP11`, то будет инкрементироваться он, т.е. станет `TMP12`.

При миграции персональных проектов, пользователи с такими же "логинами" должны существовать на сервере назначения и хотя бы раз залогиниться на нем. Если пользователь не будет найдет на целевом сервере, то его репозитории будут исключены из миграции.

При миграции репозитория на сервере назначения создается репозиторий в целевом проекте с таким же именем как исходный, если есть флаг LFS, то он выставляется. Далее репозиторий клонируется на локальную машину и отправляется на сервер назначения. Выполняются следующий git-команды:

```
git clone --bare <repository>
git lfs fetch --all
git remote set-url origin <new_repository>
git push --all
git tags --all
git lfs push origin --all
```

Команды `git lfs` выполняются только для репозиториев с включенным LFS. Для миграции LFS проектов нудно устанвить расширение [Git Large File Storage][git-lfs-ext].

**Утилита не производит миграцию разрешений проектов и репозиториев, форков, пул реквестов и комментариев к файлам.**

[git-credential-store]:https://git-scm.com/docs/git-credential-store
[git-lfs-ext]:https://git-lfs.github.com/
[build-status]:https://travis-ci.org/ashashev/smobs.svg?branch=master